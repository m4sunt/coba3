document.addEventListener('DOMContentLoaded', () => {
    // ... (previous variable declarations remain unchanged)
    const video = document.getElementById('video');
    const photoCanvas = document.getElementById('canvas');
    const previewFoto = document.getElementById('previewFoto');
    const fotoUpload = document.getElementById('fotoUpload');
    const btnAmbilFoto = document.getElementById('btnAmbilFoto');
    let stream = null; // To store the camera stream for cleanup

    // Function to check if in standalone mode
    function isInStandaloneMode() {
        return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    }

    // Initialize camera with better error handling and standalone mode check
    function initializeCamera() {
        if (isInStandaloneMode()) {
            // In standalone mode, disable browser camera and hide video-related elements
            video.style.display = 'none';
            btnAmbilFoto.style.display = 'none';
            fotoUpload.style.display = 'block'; // Ensure file input is visible
            console.log("Running in standalone mode: Browser camera disabled, use native camera via file input.");
        } else if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            // In browser mode, initialize camera stream
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
                .then(s => {
                    stream = s;
                    video.srcObject = stream;
                    console.log("Stream kamera berhasil:", stream.getVideoTracks());
                    video.style.display = 'block';
                    btnAmbilFoto.style.display = 'block';
                    fotoUpload.style.display = 'block'; // File input remains available as fallback
                })
                .catch(err => {
                    console.error("Kamera Error:", err.name, err.message);
                    let errorMessage = "Kamera tidak bisa diakses. Mohon izinkan akses kamera pada browser Anda atau unggah foto.";
                    if (err.name === "NotFoundError") {
                        errorMessage = "Kamera tidak ditemukan. Pastikan perangkat Anda memiliki kamera aktif atau unggah foto.";
                    } else if (err.name === "NotAllowedError") {
                        errorMessage = "Izin kamera ditolak. Mohon izinkan akses kamera di pengaturan browser atau unggah foto.";
                    } else if (err.name === "NotReadableError") {
                        errorMessage = "Kamera sedang digunakan oleh aplikasi lain. Tutup aplikasi tersebut dan coba lagi atau unggah foto.";
                    }
                    alert(errorMessage);
                    video.style.display = 'none';
                    btnAmbilFoto.style.display = 'none';
                    fotoUpload.style.display = 'block'; // Fallback to file input
                });
        } else {
            alert("Browser Anda tidak mendukung akses kamera. Silakan unggah foto sebagai gantinya.");
            video.style.display = 'none';
            btnAmbilFoto.style.display = 'none';
            fotoUpload.style.display = 'block';
        }
    }

    // Stop camera stream to release resources
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            video.srcObject = null;
            console.log("Camera stream stopped.");
        }
    }

    // Modified ambilFoto function
    function ambilFoto() {
        if (isInStandaloneMode()) {
            // In standalone mode, trigger file input click to use native camera
            fotoUpload.click();
        } else {
            // In browser mode, capture from video stream
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = video.videoWidth || 300;
            photoCanvas.height = video.videoHeight || 225;
            context.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);
            previewFoto.src = photoCanvas.toDataURL('image/png');
            previewFoto.style.display = 'block';
            hasPhoto = true;
            document.getElementById('photoWarning').classList.add('hidden');
            btnAmbilFoto.innerHTML = '✅ Foto Berhasil!';
            btnAmbilFoto.style.background = '#28a745';
            setTimeout(() => {
                btnAmbilFoto.innerHTML = '📸 Ambil Foto';
                btnAmbilFoto.style.background = '';
            }, 2000);
        }
    }

    // Modified handlePhotoUpload function
    function handlePhotoUpload(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewFoto.src = e.target.result;
                previewFoto.style.display = 'block';
                hasPhoto = true;
                document.getElementById('photoWarning').classList.add('hidden');
                if (isInStandaloneMode()) {
                    alert("✅ Foto dari kamera native berhasil diunggah!");
                }
            };
            reader.readAsDataURL(file);
        }
    }

    // Modified simpanData to stop camera after saving
    function simpanData() {
        let isValid = form.checkValidity();
        if (!isValid) {
            form.reportValidity();
        }

        if (!hasSignature) {
            document.getElementById('signatureWarning').classList.remove('hidden');
            signatureCanvas.classList.add('error');
            isValid = false;
        } else {
            document.getElementById('signatureWarning').classList.add('hidden');
            signatureCanvas.classList.remove('error');
        }

        if (!hasPhoto) {
            document.getElementById('photoWarning').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('photoWarning').classList.add('hidden');
        }

        if (!isValid) {
            alert("❌ Mohon lengkapi semua data yang diperlukan, termasuk Tanda Tangan dan Foto.");
            return;
        }

        const formData = {
            nama: document.getElementById('nama').value,
            asal: asal.value,
            instansi: instansi.value,
            kecamatan: kecamatan.value,
            desa: desa.value,
            pihakDitemui: document.getElementById('pihakDitemui').value,
            jenisLayanan: document.getElementById('jenisLayanan').value,
            uraian: document.getElementById('uraian').value,
            nomorHp: nomorHp.value,
            tandaTangan: signatureCanvas.toDataURL('image/png'),
            foto: previewFoto.src,
            timestamp: new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' })
        };

        dataBukuTamu.push(formData);
        localStorage.setItem('dataBukuTamu', JSON.stringify(dataBukuTamu));
        updateDataCounter();
        alert(`✅ Data berhasil disimpan! Total data: ${dataBukuTamu.length}`);
        resetFormComplete();
        stopCamera(); // Stop camera after saving data
    }

    // Modified resetFormComplete to stop camera
    function resetFormComplete() {
        form.reset();
        clearSignature();
        hasPhoto = false;
        previewFoto.style.display = 'none';
        daftarInstansi.classList.add("hidden");
        daftarMasyarakat.classList.add("hidden");
        document.getElementById('nama').focus();
        fotoUpload.value = '';
        stopCamera(); // Stop camera on form reset
        initializeCamera(); // Re-initialize camera based on mode
    }

    // ... (other functions like showForm, showData, etc., remain unchanged)

    // Initialize camera on load
    initializeCamera();

    // Event listeners
    btnForm.addEventListener('click', showForm);
    btnData.addEventListener('click', showData);
    btnExport.addEventListener('click', exportData);
    btnClearAll.addEventListener('click', clearAllData);
    btnSimpan.addEventListener('click', simpanData);
    btnClearSignature.addEventListener('click', clearSignature);
    btnAmbilFoto.addEventListener('click', ambilFoto);
    asal.addEventListener('change', handleAsalChange);
    kecamatan.addEventListener('change', populateDesa);
    nomorHp.addEventListener('input', () => { nomorHp.value = nomorHp.value.replace(/\D/g, ''); });
    fotoUpload.addEventListener('change', handlePhotoUpload);

    // ... (signature event listeners and other existing code remain unchanged)
});
